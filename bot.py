import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes

# –¢–≤–æ–π —Ç–æ–∫–µ–Ω –æ—Ç BotFather (–∑–∞–º–µ–Ω–∏ –µ–≥–æ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞!)
TOKEN = '7870381505:AAHeEF7oEJvpvc-xEJD4Q4F8111dlxWpfYM'
# –¢–≤–æ–π Telegram ID
YOUR_ID = 198389894

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –æ—Ç 1 –¥–æ 10
def create_rating_keyboard():
    keyboard = [
        [
            InlineKeyboardButton("1", callback_data='1'),
            InlineKeyboardButton("2", callback_data='2'),
            InlineKeyboardButton("3", callback_data='3'),
            InlineKeyboardButton("4", callback_data='4'),
            InlineKeyboardButton("5", callback_data='5'),
        ],
        [
            InlineKeyboardButton("6", callback_data='6'),
            InlineKeyboardButton("7", callback_data='7'),
            InlineKeyboardButton("8", callback_data='8'),
            InlineKeyboardButton("9", callback_data='9'),
            InlineKeyboardButton("10", callback_data='10'),
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ
    context.user_data.clear()
    
    # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ
    welcome_message = (
        "üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥–æ—Å—Ç–∏–Ω–∏—Ü—É –û–ª–∏–º–ø! üåü\n"
        "–ú—ã –æ—á–µ–Ω—å —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ, —Å–∫–∞–∂–∏—Ç–µ, –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –ª–∏ –≤–∞–º —É –Ω–∞—Å.(—ç—Ç–æ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã)\n"
        "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Å –æ—Ü–µ–Ω–∫–∏: –Ω–∞ —Å–∫–æ–ª—å–∫–æ –≤—ã –±—ã –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∞—à –æ—Ç–µ–ª—å (–æ—Ç 1 –¥–æ 10)?\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data['review'] = {}
    context.user_data['step'] = 'rating'  # –¢–µ–∫—É—â–∏–π —à–∞–≥: –æ—Ü–µ–Ω–∫–∞
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await update.message.reply_text(welcome_message, reply_markup=create_rating_keyboard())

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ (–æ—Ü–µ–Ω–∫–∞)
async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    if context.user_data.get('step') == 'rating':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É
        rating = query.data
        context.user_data['review']['rating'] = rating
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É (–Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã)
        context.user_data['step'] = 'room_number'
        await query.message.reply_text(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É! üòä\n"
            "–£–∫–∞–∂–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –ø—Ä–æ–∂–∏–≤–∞–µ—Ç–µ:"
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text
    user_name = update.message.from_user.first_name
    step = context.user_data.get('step')

    if step == 'room_number':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
        context.user_data['review']['room_number'] = user_message
        context.user_data['step'] = 'service'
        await update.message.reply_text(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! üôè\n"
            "–¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –Ω–∞—à–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ? (–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)"
        )

    elif step == 'service':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏
        context.user_data['review']['service'] = user_message
        context.user_data['step'] = 'room'
        await update.message.reply_text(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! üôè\n"
            "–ê —á—Ç–æ —Å–∫–∞–∂–µ—Ç–µ –æ –≤–∞—à–µ–º –Ω–æ–º–µ—Ä–µ? –£–¥–æ–±–Ω–æ –ª–∏ –≤–∞–º –±—ã–ª–æ?"
        )

    elif step == 'room':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –æ –Ω–æ–º–µ—Ä–µ
        context.user_data['review']['room'] = user_message
        context.user_data['step'] = 'comment'
        await update.message.reply_text(
            "–û—Ç–ª–∏—á–Ω–æ, –º—ã –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏! üòä\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ (–∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ '–Ω–µ—Ç', —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):"
        )

    elif step == 'comment':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        comment = user_message if user_message.lower() != '–Ω–µ—Ç' else "–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"
        context.user_data['review']['comment'] = comment
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–∑—ã–≤
        review = context.user_data['review']
        full_review = (
            f"–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç {user_name}:\n"
            f"–û—Ü–µ–Ω–∫–∞: {review['rating']}/10\n"
            f"–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã: {review['room_number']}\n"
            f"–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ: {review['service']}\n"
            f"–ù–æ–º–µ—Ä: {review['room']}\n"
            f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {review['comment']}"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –≤ —Ñ–∞–π–ª
        with open('reviews.txt', 'a', encoding='utf-8') as file:
            file.write(f"{full_review}\n{'-'*30}\n")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–±–µ –æ—Ç–∑—ã–≤
        await context.bot.send_message(
            chat_id=YOUR_ID,
            text=full_review
        )
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–ø—Ä–æ—Å
        await update.message.reply_text(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! üåü –ú—ã –æ—á–µ–Ω—å —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –∏ –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!\n"
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –æ—Ç–∑—ã–≤, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ /start."
        )
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        context.user_data.clear()

def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

if __name__ == '__main__':
    main()
